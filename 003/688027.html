<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>国泰君安 - 688027 实时行情</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #121212;
            color: #e0e0e0;
            margin: 0;
            padding: 15px;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #333;
            padding-bottom: 10px;
        }
        .stock-name {
            font-size: 24px;
            font-weight: bold;
        }
        .stock-code {
            font-size: 16px;
            color: #888;
        }
        .realtime-data {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }
        .data-item {
            background-color: #1e1e1e;
            padding: 15px;
            border-radius: 8px;
        }
        .data-item .label {
            color: #888;
            font-size: 14px;
        }
        .data-item .value {
            font-size: 22px;
            font-weight: bold;
            margin-top: 5px;
        }
        .positive {
            color: #4caf50;
        }
        .negative {
            color: #f44336;
        }
        .section-title {
            font-size: 20px;
            font-weight: bold;
            margin-top: 30px;
            margin-bottom: 15px;
            border-bottom: 1px solid #333;
            padding-bottom: 5px;
        }
        .signal {
            text-align: center;
            padding: 20px;
            border-radius: 8px;
            font-size: 28px;
            font-weight: bold;
            margin-top: 20px;
        }
        .buy-signal {
            background-color: #4caf50;
            color: white;
        }
        .sell-signal {
            background-color: #f44336;
            color: white;
        }
        .hold-signal {
            background-color: #607d8b;
            color: white;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #333;
            font-size: 14px;
        }
        th {
            background-color: #1e1e1e;
        }
        tbody tr:nth-child(even) {
            background-color: #1a1a1a;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <div class="stock-name">国泰君安</div>
                <div class="stock-code">688027</div>
            </div>
            <div id="realtime-price" style="text-align: right;">
                <!-- Real-time price will be loaded here -->
            </div>
        </div>

        <div class="realtime-data">
            <div class="data-item">
                <div class="label">今开</div>
                <div id="open-price" class="value">--</div>
            </div>
            <div class="data-item">
                <div class="label">昨收</div>
                <div id="prev-close" class="value">--</div>
            </div>
            <div class="data-item">
                <div class="label">最高</div>
                <div id="high-price" class="value">--</div>
            </div>
            <div class="data-item">
                <div class="label">最低</div>
                <div id="low-price" class="value">--</div>
            </div>
             <div class="data-item">
                <div class="label">成交量(手)</div>
                <div id="volume" class="value">--</div>
            </div>
            <div class="data-item">
                <div class="label">成交额</div>
                <div id="turnover" class="value">--</div>
            </div>
        </div>

        <div class="section-title">MACD (5, 20, 9) 分析</div>
        <div id="signal-container" class="signal hold-signal">等待数据...</div>
        <canvas id="macdChart" width="400" height="250"></canvas>

        <div class="section-title">历史数据 (最近60天)</div>
        <div style="overflow-x:auto;">
            <table id="history-table">
                <thead>
                    <tr>
                        <th>日期</th>
                        <th>收盘价</th>
                        <th>涨跌幅</th>
                        <th>成交量</th>
                        <th>换手率</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Data will be loaded here -->
                </tbody>
            </table>
        </div>

        <div class="section-title">融资融券 (最近10日)</div>
         <div style="overflow-x:auto;">
            <table>
                <thead>
                    <tr>
                        <th>日期</th>
                        <th>融资余额(元)</th>
                        <th>融资买入额(元)</th>
                        <th>融券余量</th>
                        <th>融券卖出量</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Placeholder Data -->
                    <tr><td>2025-12-22</td><td>1.50B</td><td>85.12M</td><td>50.11K</td><td>2.31K</td></tr>
                    <tr><td>2025-12-19</td><td>1.48B</td><td>79.34M</td><td>51.34K</td><td>3.10K</td></tr>
                    <tr><td>2025-12-18</td><td>1.47B</td><td>92.11M</td><td>50.01K</td><td>1.88K</td></tr>
                    <tr><td>2025-12-17</td><td>1.45B</td><td>68.88M</td><td>52.78K</td><td>4.52K</td></tr>
                    <tr><td>2025-12-16</td><td>1.46B</td><td>71.05M</td><td>54.12K</td><td>2.01K</td></tr>
                    <tr><td>2025-12-15</td><td>1.43B</td><td>88.19M</td><td>53.00K</td><td>1.56K</td></tr>
                    <tr><td>2025-12-12</td><td>1.42B</td><td>95.43M</td><td>51.89K</td><td>5.87K</td></tr>
                    <tr><td>2025-12-11</td><td>1.40B</td><td>102.33M</td><td>49.98K</td><td>3.44K</td></tr>
                    <tr><td>2025-12-10</td><td>1.38B</td><td>76.57M</td><td>50.76K</td><td>2.98K</td></tr>
                    <tr><td>2025-12-09</td><td>1.39B</td><td>81.22M</td><td>48.88K</td><td>4.11K</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
    document.addEventListener("DOMContentLoaded", function() {
        const CSV_PATH = './out/688027_stock_data.csv';

        Papa.parse(CSV_PATH, {
            download: true,
            header: true,
            dynamicTyping: true,
            complete: function(results) {
                const stockData = results.data.filter(row => row['日期']);
                if (stockData.length === 0) {
                    console.error("未能加载或解析CSV数据");
                    return;
                }
                
                // 1. 设置实时数据
                const latestData = stockData[stockData.length - 1];
                const prevData = stockData[stockData.length - 2];

                const priceChange = latestData['收盘'] - prevData['收盘'];
                const priceChangePercent = (priceChange / prevData['收盘']) * 100;
                const priceClass = priceChange >= 0 ? 'positive' : 'negative';

                document.getElementById('realtime-price').innerHTML = `
                    <div class="value ${priceClass}" style="font-size: 28px;">${latestData['收盘'].toFixed(2)}</div>
                    <div class="${priceClass}" style="font-size: 16px;">
                        <span>${priceChange.toFixed(2)}</span>
                        <span>(${priceChangePercent.toFixed(2)}%)</span>
                    </div>
                `;
                document.getElementById('open-price').textContent = latestData['开盘'].toFixed(2);
                document.getElementById('prev-close').textContent = prevData['收盘'].toFixed(2);
                document.getElementById('high-price').textContent = latestData['最高'].toFixed(2);
                document.getElementById('low-price').textContent = latestData['最低'].toFixed(2);
                document.getElementById('volume').textContent = (latestData['成交量'] / 100).toFixed(2) + '万';
                document.getElementById('turnover').textContent = (latestData['成交额'] / 100000000).toFixed(2) + '亿';

                // 2. 计算MACD
                const closingPrices = stockData.map(row => row['收盘']);
                const macdResult = calculateMACD(closingPrices, 5, 20, 9);

                // 3. 生成买卖信号
                generateSignal(macdResult);
                
                // 4. 渲染图表
                renderChart(stockData, macdResult);

                // 5. 填充历史数据表格
                populateHistoryTable(stockData.slice(-60));
            }
        });

        function calculateEMA(data, period) {
            const k = 2 / (period + 1);
            let ema = [data[0]];
            for (let i = 1; i < data.length; i++) {
                ema.push(data[i] * k + ema[i - 1] * (1 - k));
            }
            return ema;
        }

        function calculateMACD(data, shortPeriod, longPeriod, signalPeriod) {
            const emaShort = calculateEMA(data, shortPeriod);
            const emaLong = calculateEMA(data, longPeriod);
            
            const dif = [];
            for(let i = 0; i < data.length; i++) {
                dif.push(emaShort[i] - emaLong[i]);
            }
            
            const dea = calculateEMA(dif, signalPeriod);
            
            const macd = [];
            for (let i = 0; i < data.length; i++) {
                macd.push(2 * (dif[i] - dea[i]));
            }

            return { dif, dea, macd };
        }
        
        function generateSignal(macdResult) {
            const { dif, dea } = macdResult;
            const signalContainer = document.getElementById('signal-container');
            
            const lastDif = dif[dif.length - 1];
            const lastDea = dea[dea.length - 1];
            const prevDif = dif[dif.length - 2];
            const prevDea = dea[dea.length - 2];

            let signalText = '持有/观察';
            let signalClass = 'hold-signal';

            // 金叉: DIF从下向上穿越DEA
            if (prevDif < prevDea && lastDif > lastDea) {
                signalText = '买入信号 (金叉)';
                signalClass = 'buy-signal';
            } 
            // 死叉: DIF从上向下穿越DEA
            else if (prevDif > prevDea && lastDif < lastDea) {
                signalText = '卖出信号 (死叉)';
                signalClass = 'sell-signal';
            }
            // 其他情况
            else if(lastDif > lastDea){
                signalText = '多头趋势';
                signalClass = 'buy-signal';
            } else {
                 signalText = '空头趋势';
                 signalClass = 'sell-signal';
            }

            signalContainer.textContent = signalText;
            signalContainer.className = 'signal ' + signalClass;
        }

        function renderChart(stockData, macdResult) {
            const labels = stockData.map(row => row['日期']).slice(-60);
            const priceData = stockData.map(row => row['收盘']).slice(-60);
            const difData = macdResult.dif.slice(-60);
            const deaData = macdResult.dea.slice(-60);
            const macdData = macdResult.macd.slice(-60);

            const ctx = document.getElementById('macdChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            type: 'line',
                            label: '收盘价',
                            data: priceData,
                            borderColor: '#e0e0e0',
                            yAxisID: 'yPrice',
                            tension: 0.1,
                            borderWidth: 2,
                            pointRadius: 0
                        },
                        {
                            type: 'line',
                            label: 'DIF (快线)',
                            data: difData,
                            borderColor: '#ffab00',
                            yAxisID: 'yMACD',
                            tension: 0.1,
                             borderWidth: 1,
                            pointRadius: 0
                        },
                        {
                            type: 'line',
                            label: 'DEA (慢线)',
                            data: deaData,
                            borderColor: '#00e5ff',
                            yAxisID: 'yMACD',
                             tension: 0.1,
                             borderWidth: 1,
                            pointRadius: 0
                        },
                         {
                            type: 'bar',
                            label: 'MACD柱',
                            data: macdData,
                             yAxisID: 'yMACD',
                            backgroundColor: function(context) {
                                const value = context.dataset.data[context.dataIndex];
                                return value >= 0 ? 'rgba(76, 175, 80, 0.7)' : 'rgba(244, 67, 54, 0.7)';
                            }
                        }
                    ]
                },
                options: {
                   scales: {
                        x: {
                            ticks: {
                                color: '#888',
                                maxRotation: 0,
                                autoSkip: true,
                                maxTicksLimit: 8
                            },
                            grid: {
                                color: '#333'
                            }
                        },
                        yPrice: {
                            position: 'left',
                            ticks: { color: '#888' },
                            grid: { color: '#333' }
                        },
                        yMACD: {
                            position: 'right',
                            ticks: { color: '#888' },
                            grid: { drawOnChartArea: false }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: '#e0e0e0'
                            }
                        }
                    }
                }
            });
        }

        function populateHistoryTable(data) {
            const tableBody = document.getElementById('history-table').getElementsByTagName('tbody')[0];
            let html = '';
            // Newest first
            for (let i = data.length - 1; i >= 0; i--) {
                const row = data[i];
                const changeClass = row['涨跌幅'] >= 0 ? 'positive' : 'negative';
                html += `
                    <tr>
                        <td>${row['日期']}</td>
                        <td>${row['收盘'].toFixed(2)}</td>
                        <td class="${changeClass}">${row['涨跌幅'].toFixed(2)}%</td>
                        <td>${(row['成交量']/10000).toFixed(2)}万</td>
                        <td>${row['换手率'].toFixed(2)}%</td>
                    </tr>
                `;
            }
            tableBody.innerHTML = html;
        }
    });
    </script>
</body>
</html>
